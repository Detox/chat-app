// Generated by LiveScript 1.5.0
/**
 * @package Detox chat app
 * @author  Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @license 0BSD
 */
(function(){
  function Wrapper(detoxUtils, asyncEventer){
    var global_state;
    global_state = Object.create(null);
    function State(name, initial_state){
      var x$, i$, ref$, len$, secret, contact, this$ = this;
      if (!(this instanceof State)) {
        return new State(name, initial_state);
      }
      asyncEventer.call(this);
      if (!initial_state) {
        initial_state = localStorage.getItem(name);
        initial_state = initial_state
          ? JSON.parse(initial_state)
          : Object.create(null);
      }
      this._state = initial_state;
      this._local_state = {
        online: false,
        announced: false,
        messages: detoxUtils.ArrayMap(),
        ui: {
          active_contact: null
        }
      };
      if (!('version' in this._state)) {
        x$ = this._state;
        x$['version'] = 0;
        x$['name'] = '';
        x$['seed'] = null;
        x$['settings'] = {
          'announce': true
        };
        x$['secrets'] = [];
        x$['contacts'] = [[[6, 148, 79, 1, 76, 156, 177, 211, 195, 184, 108, 220, 189, 121, 140, 15, 134, 174, 141, 222, 146, 77, 20, 115, 211, 253, 148, 149, 128, 147, 190, 125], 'Fake contact', +Date, +Date]];
      }
      if (this._state['seed']) {
        this._state['seed'] = Uint8Array.from(this._state['seed']);
      }
      for (i$ = 0, len$ = (ref$ = this._state['secrets']).length; i$ < len$; ++i$) {
        secret = ref$[i$];
        secret['secret'] = Uint8Array.from(secret['secret']);
      }
      for (i$ = 0, len$ = (ref$ = this._state['contacts']).length; i$ < len$; ++i$) {
        contact = ref$[i$];
        contact[0] = Uint8Array.from(contact[0]);
      }
      this._local_state.messages.set(this._state['contacts'][0][0], [[true, +new Date, 'Received message'], [false, +new Date, 'Sent message']]);
      this._ready = new Promise(function(resolve){
        if (this$._state['seed']) {
          resolve();
        } else {
          this$._ready_resolve = resolve;
        }
      });
    }
    State.prototype = {
      /**
       * @param {Function} callback Callback to be executed once state is ready
       *
       * @return {boolean} Whether state is ready
       */
      'ready': function(callback){
        if (callback) {
          this._ready.then(callback);
        }
        return Boolean(this._state['seed']);
      }
      /**
       * @return {Uint8Array} Seed if configured or `null` otherwise
       */,
      'get_seed': function(){
        return this._state['seed'];
      }
      /**
       * @param {!Uint8Array} seed
       */,
      'set_seed': function(seed){
        var old_seed, new_seed;
        old_seed = this._state['seed'];
        new_seed = Uint8Array.from(seed);
        this._state['seed'] = new_seed;
        if (this._ready_resolve) {
          this._ready_resolve();
          delete this._ready_resolve;
        }
        this['fire']('seed_changed', new_seed, old_seed);
      }
      /**
       * @return {Uint8Array} Seed if configured or `null` otherwise
       */,
      'get_name': function(){
        return this._state['name'];
      }
      /**
       * @param {string} name
       */,
      'set_name': function(name){
        var old_name, new_name;
        old_name = this._state['name'];
        new_name = String(name);
        this._state['name'] = new_name;
        this['fire']('name_changed', new_name, old_name);
      }
      /**
       * @return {boolean}
       */,
      'get_online': function(){
        return this._local_state.online;
      }
      /**
       * @param {boolean} online
       */,
      'set_online': function(online){
        var old_online, new_online;
        old_online = this._local_state.online;
        new_online = !!online;
        this._local_state.online = new_online;
        this['fire']('online_changed', new_online, old_online);
      }
      /**
       * @return {boolean}
       */,
      'get_announced': function(){
        return this._local_state.announced;
      }
      /**
       * @param {boolean} announced
       */,
      'set_announced': function(announced){
        var old_announced, new_announced;
        old_announced = this._local_state.announced;
        new_announced = !!announced;
        this._local_state.announced = new_announced;
        this['fire']('announced_changed', new_announced, old_announced);
      }
      /**
       * @return {boolean}
       */,
      'get_ui_active_contact': function(){
        return this._local_state.ui.active_contact;
      }
      /**
       * @param {!Uint8Array} public_key
       */,
      'set_ui_active_contact': function(public_key){
        var old_active_contact, new_active_contact;
        old_active_contact = this._local_state.ui.active_contact;
        new_active_contact = Uint8Array.from(new_active_contact);
        this._local_state.ui.active_contact = new_active_contact;
        this['fire']('ui_active_contact_changed', new_active_contact, old_active_contact);
      }
      /**
       * @return {boolean}
       */,
      'get_settings_announce': function(){
        return this._state['settings']['announce'];
      }
      /**
       * @param {boolean} announce
       */,
      'set_settings_announce': function(announce){
        var old_announce, new_announce;
        old_announce = this._state['settings']['announce'];
        new_announce = !!announce;
        this._state['settings']['announce'] = new_announce;
        this['fire']('settings_announce_changed');
      }
      /**
       * @return {!Array<!Object>}
       */,
      'get_contacts': function(){
        return this._state['contacts'];
      }
      /**
       * @param {!Uint8Array} public_key
       *
       * @return {!Array<!Array>} Each inner array is `[from, date, text]`, where `received` is `true` if message was received and `false` if sent to a friend
       */,
      'get_contact_messages': function(public_key){
        return this._local_state.messages.get(public_key) || [];
      }
      /**
       * @param {!Uint8Array}	public_key
       * @param {boolean}		from		`true` if message was received and `false` if sent to a friend
       * @param {number}		date
       * @param {string} 		text
       */,
      'add_contact_message': function(public_key, from, date, text){
        var messages, message;
        if (!this._local_state.messages.has(public_key)) {
          this._local_state.messages.set(public_key, []);
        }
        public_key = Uint8Array.from(public_key);
        messages = this._local_state.messages.get(public_key);
        message = [from, date, text];
        messages.push(message);
        this['fire']('contact_messages_changed', public_key, message);
      }
    };
    State.prototype = Object.assign(Object.create(asyncEventer.prototype), State.prototype);
    Object.defineProperty(State.prototype, 'constructor', {
      enumerable: false,
      value: State
    });
    return {
      'State': State
      /**
       * @param {string}	name
       * @param {!Object}	initial_state
       *
       * @return {!detoxState}
       */,
      'get_instance': function(name, initial_state){
        if (!(name in global_state)) {
          global_state[name] = State(initial_state);
        }
        return global_state[name];
      }
    };
  }
  define(['@detox/utils', 'async-eventer'], Wrapper);
}).call(this);
